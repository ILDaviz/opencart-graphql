<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>Delivery Agent Module</name>
    <version>2.0 (Initial)</version>
  	<author>Malsapp</author>
	  <code>google_map_checkout</code>
		<file path="catalog/language/en-gb/checkout/checkout.php">
			<operation>
    		<search>
    			<![CDATA[
$_['entry_shipping'] 	             = 'My delivery and billing addresses are the same.';
   			]]>
    		</search>
    		<add position="before">
    			<![CDATA[
$_['entry_geocode']      = 'Mark Your Location';
  			]]>
    		</add>
			</operation>
		</file>
    <file path="catalog/controller/checkout/checkout.php">
    	<operation>
    		<search>
    			<![CDATA[
    			public function index() {
    			]]>
    		</search>
    		<add position="after">
    			<![CDATA[
    			$this->document->addScript('https://maps.googleapis.com/maps/api/js?key=AIzaSyCalEYf5vgQANGE9c_SkFSOuBMC5wA9PSk');
    			]]>
    		</add>
    	</operation>
    </file>
    <file path="catalog/view/theme/*/template/checkout/checkout.tpl">
    	<operation>
    		<search>
    			<![CDATA[
        data: $('#collapse-shipping-address input[type=\'text\'], #collapse-shipping-address input[type=\'date\'], #collapse-shipping-address input[type=\'datetime-local\'], #collapse-shipping-address input[type=\'time\'], #collapse-shipping-address input[type=\'password\'], #collapse-shipping-address input[type=\'checkbox\']:checked, #collapse-shipping-address input[type=\'radio\']:checked, #collapse-shipping-address textarea, #collapse-shipping-address select'),
  			]]>
    		</search>
    		<add position="replace">
    			<![CDATA[
        data: $('#collapse-shipping-address input[type=\'text\'], #collapse-shipping-address input[type=\'date\'], #collapse-shipping-address input[type=\'datetime-local\'], #collapse-shipping-address input[type=\'time\'], #collapse-shipping-address input[type=\'password\'], #collapse-shipping-address input[type=\'checkbox\']:checked, #collapse-shipping-address input[type=\'radio\']:checked, #collapse-shipping-address textarea, #collapse-shipping-address select, #collapse-shipping-address input[type=\'hidden\']'),    			]]>
    		</add>
    	</operation>
    </file>
    <file path="catalog/view/theme/*/template/checkout/shipping_address.tpl">
  		<operation>
    		<search>
    			<![CDATA[
     <?php foreach ($custom_fields as $custom_field) { ?>
   			]]>
    		</search>
    		<add position="before">
    			<![CDATA[
            <input id="user_location" name="geocode" type="hidden" value="" />
  			]]>
    		</add>
    	</operation>
    	 <operation>
            <search>
                <![CDATA[
   <div class="buttons clearfix">
           ]]>
            </search>
            <add position="before">
                <![CDATA[
  <div>
    <label>
      <input type="radio" name="shipping_address" value="map" />
      Or Mark You Address</label>
        <div class="form-group required">
      <label class="col-sm-2 control-label" for="input-postcode"><?php echo $entry_geocode; ?></label>
      <div class="col-sm-10">
        <div id="map_contact" style="width:100%; height: 300px; background-color:#333;"></div>
       </div>
     </div>
  </div>
                ]]>
            </add>
        </operation>
    	<operation>
    		<search>
    			<![CDATA[
//--></script>
				]]>
    		</search>
    		<add position="after">
    			<![CDATA[
<script type="text/javascript">
  var uluru = <?php echo !empty($geocode)?"{lat:${geocode['lat']},lng:${geocode['lng']} }":'{lat: 30.11883, lng: 31.61103}';?>;
  var geocoder = new google.maps.Geocoder;
  var mapOptions = {
    center: uluru,
    zoom: 15
  };
 var map = new google.maps.Map(document.getElementById("map_contact"), mapOptions);
 var marker = new google.maps.Marker({
    position: uluru,
    map: map,
    title: 'You are there!'
  });
  google.maps.event.addListener(map, 'click', function(event) {
    if ( marker ) {
      marker.setPosition(event.latLng);
    } else {
      marker = new google.maps.Marker({
        position: event.latLng,
        map: map
      });
    }
    var latlng=event.latLng;
    $("#user_location").val(latlng);
  });
</script>
 			]]>
    		</add>
    	</operation>
    </file>
    <file path="catalog/controller/checkout/shipping_address.php">
        <operation>
            <search>
                <![CDATA[
		$data['button_upload'] = $this->language->get('button_upload');
                ]]>
            </search>
            <add position="after">
                <![CDATA[
    $data['entry_geocode'] = $this->language->get('entry_geocode');
                ]]>
            </add>
        </operation>
        <operation>
            <search index="1">
                <![CDATA[
            $this->load->model('account/address');
                ]]>
            </search>
            <add position="after">
                <![CDATA[
		$address = $this->model_account_address->getAddress($this->customer->getAddressId());
		if(strlen($address['geocode'])>0){
			$db_geocode=$address['geocode'];
			$geocode=explode(',',str_replace(")",'',str_replace('(','',$db_geocode)));
			$data['geocode']['lat']=$geocode[0];
			$data['geocode']['lng']=$geocode[1];
		}else{
			$data['geocode']="";
		}
                ]]>
            </add>
        </operation>
        <operation>
            <search index="3">
                <![CDATA[
				if (!$json) {
                ]]>
            </search>
            <add position="before">
                <![CDATA[
				if(utf8_strlen(trim($this->request->post['geocode']))>10){
					$json=null;
				}
                ]]>
            </add>
        </operation>
          <operation>
            <search index="3">
                <![CDATA[
				if (!$json) {
                ]]>
            </search>
            <add position="after" offset="4">
                <![CDATA[
					$address_id=null;
					if(utf8_strlen(trim($this->request->post['geocode']))>10){
						$this->load->model('account/address');
						$address_id = $this->customer->getAddressId();
						$address = $this->model_account_address->getAddress($this->customer->getAddressId());
						$this->load->model('account/address');
						$address['geocode']=$this->request->post['geocode'];
						$this->model_account_address->editAddress($address_id,$address);
					}else{
						// Default Shipping Address
						$this->load->model('account/address');
						$address_id = $this->model_account_address->addAddress($this->request->post);
					}
                ]]>
            </add>
        </operation>
    </file>
</modification>