<?xml version="1.0" encoding="UTF-8"?>
<modification>
	<id>Login Mobile</id>
	<version>OC 2.x</version>
	<vqmver>2.0.0</vqmver>
	<author>Malsapp</author>
	<file  name="catalog/model/account/customer.php">
		<operation>
			<search position="before"><![CDATA[
	public function getRewardTotal($customer_id) {
			]]></search>
			<add><![CDATA[
				public function getCustomerByPhone($phone) {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE LOWER(telephone) = '" . $this->db->escape(utf8_strtolower($phone)) . "'");

					return $query->row;
				}

				public function getTotalCustomersByPhoneNumber($telephone) {
					$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "customer WHERE LOWER(telephone) = '" . $this->db->escape(utf8_strtolower($telephone)) . "'");

					return $query->row['total'];
				}
			]]></add>
		</operation>
	</file>

	<file  name="system/library/cart/customer.php">
		<operation>
			<search position="replace"><![CDATA[
				return false;
			]]></search>
			<add><![CDATA[
			$customer_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE ( LOWER(email) = '" . $this->db->escape(utf8_strtolower($email))."' or telephone='".$this->db->escape(utf8_strtolower($email)). "') AND (password = SHA1(CONCAT(salt, SHA1(CONCAT(salt, SHA1('" . $this->db->escape($password) . "'))))) OR password = '" . $this->db->escape(md5($password)) . "') AND status = '1' AND approved = '1'");
			if ($customer_query->num_rows) {
					$this->session->data['customer_id'] = $customer_query->row['customer_id'];

					$this->customer_id = $customer_query->row['customer_id'];
					$this->firstname = $customer_query->row['firstname'];
					$this->lastname = $customer_query->row['lastname'];
					$this->customer_group_id = $customer_query->row['customer_group_id'];
					$this->email = $customer_query->row['email'];
					$this->telephone = $customer_query->row['telephone'];
					$this->fax = $customer_query->row['fax'];
					$this->newsletter = $customer_query->row['newsletter'];
					$this->address_id = $customer_query->row['address_id'];

					$this->db->query("UPDATE " . DB_PREFIX . "customer SET language_id = '" . (int)$this->config->get('config_language_id') . "', ip = '" . $this->db->escape($this->request->server['REMOTE_ADDR']) . "' WHERE customer_id = '" . (int)$this->customer_id . "'");

					return true;
				} else {
				return false;
				}
			]]></add>
		</operation>
	</file>
	<file  name="catalog/controller/account/login.php">
		<operation>
			<search position="replace" offset="5"><![CDATA[
		// Check if customer has been approved.
			]]></search>
			<add><![CDATA[
		$customer_info =array();
		$customer_info = $this->model_account_customer->getCustomerByEmail($this->request->post['email']);
	  if($customer_info && !$customer_info['approved']){ 
		 	$customer_info = $this->model_account_customer->getCustomerByPhone($this->request->post['email']);
		}
			]]></add>
		</operation>
	</file>
	<file  name="catalog/language/en-gb/account/login.php">
		<operation>
			<search position="replace"><![CDATA[
$_['entry_email']                  = 'E-Mail Address';
			]]></search>
			<add><![CDATA[
$_['entry_email']                  = 'E-Mail Address or Mobile Number';
			]]></add>
		</operation>
	</file>
	<file  name="catalog/language/en-gb/account/register.php">
		<operation>
			<search position="after"><![CDATA[
$_['error_agree']          = 'Warning: You must agree to the %s!';
			]]></search>
			<add><![CDATA[
$_['error_telephone_exists']               = 'Warning: Mobile Number is already registered.';
			]]></add>
		</operation>
	</file>

	<file  name="catalog/controller/account/register.php">
		<operation>
			<search position="before"><![CDATA[
		if ((utf8_strlen($this->request->post['telephone']) < 3) || (utf8_strlen($this->request->post['telephone']) > 32)) {
			]]></search>
			<add><![CDATA[
		if ($this->model_account_customer->getTotalCustomersByPhoneNumber($this->request->post['telephone'])) {
			$this->error['warning'] = $this->language->get('error_telephone_exists');
		}		
			]]></add>
		</operation>
	</file>
</modification>