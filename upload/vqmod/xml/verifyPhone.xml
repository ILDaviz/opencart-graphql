<?xml version="1.0" encoding="UTF-8"?>
<modification>
	<id>Verify Mobile Number</id>
	<version>OC 2.x</version>
	<vqmver>2.0.0</vqmver>
	<author>Malsapp</author>
	<file name="catalog/language/en-gb/account/register.php">
		<operation>
			<search position="after"><![CDATA[
$_['entry_telephone']      = 'Telephone';
			]]></search>
			<add><![CDATA[
$_['entry_country_code']      = 'Country Code';
$_['entry_verification_code']      = 'Verification Code';
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
$_['error_telephone']      = 'Telephone must be between 3 and 32 characters!';
			]]></search>
			<add><![CDATA[
$_['error_verification_code']      = 'Verification Code is not correct!';
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/account/register.php">
		<operation>
			<search position="after"><![CDATA[
		$data['entry_telephone'] = $this->language->get('entry_telephone');
			]]></search>
			<add><![CDATA[
		$data['entry_country_code'] = $this->language->get('entry_country_code');
		$data['entry_verification_code'] = $this->language->get('entry_verification_code');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
		if (isset($this->error['telephone'])) {
			]]></search>
			<add><![CDATA[
		if (isset($this->error['verification_code'])) {
			$data['error_verification_code'] = $this->error['verification_code'];
		} else {
			$data['error_verification_code'] = '';
		}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
		if (isset($this->request->post['fax'])) {
	 ]]></search>
			<add><![CDATA[
		if (isset($this->request->post['country_code'])) {
			$data['country_code'] = $this->request->post['country_code'];
		} else {
			$data['country_code'] = '';
		}

		if (isset($this->request->post['verification_code'])) {
			$data['verification_code'] = $this->request->post['verification_code'];
		} else {
			$data['verification_code'] = '';
		}
	 ]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
		if ((utf8_strlen(trim($this->request->post['address_1'])) < 3) || (utf8_strlen(trim($this->request->post['address_1'])) > 128)) {
	 ]]></search>
			<add><![CDATA[
		if (!isset($this->request->post['verification_code']) || $this->request->post['verification_code'] == '' || !is_numeric($this->request->post['verification_code'])) {
			$this->error['verification_code'] = $this->language->get('error_verification_code');
		}else{
			$api_key="Mdaar3SzEnPsRU2IXGejCFzUn1tLOThJ";
			$country_code=$this->request->post['country_code'];
			$telephone=$this->request->post['telephone'];
			$locale="en";
			$verification_code=$this->request->post['verification_code'];
			$ch = curl_init();

			curl_setopt($ch, CURLOPT_URL, "https://api.authy.com/protected/json/phones/verification/check?api_key={$api_key}&phone_number={$telephone}&country_code={$country_code}&verification_code={$verification_code}");
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

			$result = json_decode(curl_exec($ch),true);
			if (curl_errno($ch)) {
					echo 'Error:' . curl_error($ch);
			}
			curl_close ($ch);
			if(isset($result['errors'])){
				$this->error['verification_code'] = $this->language->get('error_verification_code');
			}			
		}
	]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
	private $error = array();
	 ]]></search>
			<add><![CDATA[
	public function getVerificationCode(){
		$api_key="Mdaar3SzEnPsRU2IXGejCFzUn1tLOThJ";
		$country_code=$this->request->get['country_code'];
		$telephone=$this->request->get['telephone'];
		$locale="en";
		$ch = curl_init();

		curl_setopt($ch, CURLOPT_URL, "https://api.authy.com/protected/json/phones/verification/start?api_key={$api_key}");
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($ch, CURLOPT_POSTFIELDS,"via=sms&phone_number={$telephone}&country_code={$country_code}&locale={$locale}");
		curl_setopt($ch, CURLOPT_POST, 1);
		$headers = array();
		$headers[] = "Content-Type: application/x-www-form-urlencoded";
		curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

		$result = curl_exec($ch);
		if (curl_errno($ch)) {
			$json['error']="Error, Please Check Telephone and Country Code";
		}
		curl_close ($ch);
		
		$json=array();
		
		$this->response->addHeader('Content-Type: application/json');
		$this->response->setOutput(json_encode($json));
	}
	 ]]></add>
		</operation>
	</file>
	<file name="catalog/view/theme/*/template/account/register.tpl">
		<operation>
			<search position="before"><![CDATA[
<?php echo $footer; ?>
			]]></search>
			<add><![CDATA[
<script type="text/javascript">
let verify=0;
$('#send-verify-code').click(function(e){
	e.preventDefault();
	$.ajax({
		url:'index.php?route=account/register/getVerificationCode',
		dataType: 'json',
		data:{
			'country_code':$('#input-country_code').val(),
			'telephone':$('#input-telephone').val()
		},
		success:function(res){
			console.log(res);
			if(res['error']){
				$('#hint-verify').text(res['error']);
			}else{
				if(verify==0){
					$('#hint-verify').text('Verification Code Sent. Enter it in the proposed field');
					verify +=1;
				}else{
					$('#hint-verify').text('Verification Code has been resent. Enter it in the proposed field');
				}							
			}
		}
	})
});
</script>
	 ]]></add>
		</operation>
				<operation>
			<search position="replace" offset="5"><![CDATA[
              <input type="tel" name="telephone" value="<?php echo $telephone; ?>" placeholder="<?php echo $entry_telephone; ?>" id="input-telephone" class="form-control" />
			]]></search>
			<add><![CDATA[
							<input type="text" name="country_code" value="<?php echo $country_code; ?>" placeholder="<?php echo $entry_country_code; ?>" id="input-country_code" class="form-control" style="width:30%;float:left;margin-right:5px;" maxlength="4"/>
              <input type="tel" name="telephone" value="<?php echo $telephone; ?>" placeholder="<?php echo $entry_telephone; ?>" id="input-telephone" class="form-control" style="width:50%;float:left;margin-right:5px;" />
              <?php if ($error_telephone) { ?>
              <div class="text-danger"><?php echo $error_telephone; ?></div>
              <?php } ?>
            </div>
          </div>
					
					<div class="form-group required">
            <label class="col-sm-2 control-label" for="input-verify-code"><?php echo $entry_verification_code; ?></label>
            <div class="col-sm-10">
              <input type="number" name="verification_code" value="<?php echo $verification_code; ?>" placeholder="<?php echo $entry_verification_code; ?>" id="input-verify-code" class="form-control" style="width:30%;float:left;margin-right:5px;"/>
							<button id="send-verify-code" class="btn btn-sm btn-success">Send/Resend Verification Code</button>
							<div>
								<span id="hint-verify"></span>
							</div>
              <?php if ($error_verification_code) { ?>
              <div class="text-danger"><?php echo $error_verification_code; ?></div>
              <?php } ?>
            </div>
          </div>
	 ]]></add>
		</operation>
	</file>
</modification>