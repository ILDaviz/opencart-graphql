<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>Delivery Agent Module</name>
    <version>2.0 (Initial)</version>
  	<author>Malsapp</author>
	  <code>delivery agent handling module</code>

    <file path="catalog/controller/account/address.php">
        <operation>
            <search>
                <![CDATA[
              protected function getForm() {
                ]]>
            </search>
            <add position="after">
                <![CDATA[
                    $this->document->addScript('https://maps.googleapis.com/maps/api/js?key=AIzaSyCalEYf5vgQANGE9c_SkFSOuBMC5wA9PSk');
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[
              $data['entry_default'] = $this->language->get('entry_default');
                ]]>
            </search>
            <add position="after">
                <![CDATA[
            $data['entry_geocode'] = $this->language->get('entry_geocode');
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[
            if (isset($this->request->post['firstname'])) {
                ]]>
            </search>
            <add position="before">
                <![CDATA[
            if (isset($this->request->post['geocode'])) {
              $data['geocode'] = $this->request->post['geocode'];
            } elseif (!empty($address_info)) {
              $data['geocode'] = $address_info['geocode'];
            } else {
              $data['geocode'] = '';
            }
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/view/theme/*/template/account/address_form.tpl">
       <operation>
           <search><![CDATA[
              </fieldset>
            ]]></search>
           <add position="after"><![CDATA[
            <div class="form-group required">
              <label class="col-sm-2 control-label" for="input-postcode"><?php echo $entry_geocode; ?></label>
              <div class="col-sm-10">
                   <input id="user_location" name="geocode" type="hidden" value="" />
                   <div id="map_contact" style="width:100%; height: 300px; background-color:#333;"></div>
               </div>
             </div>
               ]]></add>
       </operation>
       <operation>
          <search><![CDATA[
<script type="text/javascript"><!--
          ]]></search>
           <add position="before"><![CDATA[

                <script type="text/javascript">
                (function($) {
  var map;
  var marker;

  function initialize_map() {
    var LAT_LNG = new google.maps.LatLng(<?php echo !empty($geocode)?substr($geocode,1,strlen($geocode)):' 30.11883,31.61103';?>); //  add your location here
    var mapOptions = {
          center: LAT_LNG,
          zoom: 15
      };
    map = new google.maps.Map(document.getElementById("map_contact"), mapOptions);

     marker = new google.maps.Marker({
        position: LAT_LNG,
        map: map,
        title: 'You are there!'
      });
        google.maps.event.addListener(map, 'click', function(event) {
          if ( marker ) {
            marker.setPosition(event.latLng);
          } else {
            marker = new google.maps.Marker({
              position: event.latLng,
              map: map
            });
          }
          $("#user_location").val(event.latLng);
      });
    }
     google.maps.event.addDomListener(window, 'load', initialize_map);

 })(jQuery);

                   </script>
           ]]></add>
       </operation>
   </file>

  <file path="catalog/language/en-gb/account/address.php">
      <operation>
          <search>
              <![CDATA[
$_['entry_default']        = 'Default Address';
              ]]>
          </search>
          <add position="after">
              <![CDATA[
          $_['entry_geocode']      = 'Mark Your Location';
              ]]>
          </add>
      </operation>
  </file>

  <file path="catalog/model/account/address.php">
    <operation>
        <search>
            <![CDATA[
    'address_id'     => $address_query->row['address_id'],
            ]]>
        </search>
        <add position="after">
            <![CDATA[
      'geocode' => isset ($address_query->row['geocode']) ? $address_query->row['geocode'] : '',
            ]]>
        </add>
    </operation>
    <operation>
        <search>
            <![CDATA[
        if (!empty($data['default'])) {
            ]]>
        </search>
        <add position="before">
            <![CDATA[
       $this->db->query("UPDATE " . DB_PREFIX . "address SET geocode = '" . $this->db->escape(isset ($data['geocode']) ? $data['goecode'] : '') . "' WHERE address_id = '" . (int)$address_id . "'");
            ]]>
        </add>
    </operation>
  </file>
  <file name="admin/controller/common/column_left.php">
    <operation>
      <search position="before"><![CDATA[
        if ($this->user->hasPermission('access', 'extension/event')) {
      ]]></search>
      <add><![CDATA[
        if ($this->user->hasPermission('access', 'extension/delivery_agent')) {
          $extension[] = array(
            'name'     => 'Delivery Agents',
            'href'     => $this->url->link('extension/delivery_agent', 'token=' . $this->session->data['token'], true),
            'children' => array()
          );
        }
      ]]></add>
    </operation>
  </file>
  <file name="admin/controller/sale/order.php">
    <operation>
      <search position="after" index="1"><![CDATA[
       $order_info = $this->model_sale_order->getOrder($order_id);
      ]]></search>
      <add><![CDATA[
        $data['lat_long'] = '';
        try {
            $custom = is_string($order_info['shipping_custom_field']) ? $order_info['shipping_custom_field'] : '';
            $json_data = json_decode($custom);
            $data['lat_long'] = isset($json_data->gps) ? $json_data->gps->location->latitude . ',' . $json_data->gps->location->longitude : null;
        } catch (\Exception $e) {
          var_dump($e);
        }

        $data['delivery_agents']=array();
        $this->load->model('extension/delivery_agent');
        $delivery_agents=$this->model_extension_delivery_agent->getDeliveryAgents();
        $data['delivery_agents']=$delivery_agents;
        $data['text_delivery_agent']='Assign Agent ';
        $result=$this->db->query("SELECT * FROM oc_delivery_agent_order WHERE order_id = $order_id");
        if($result->num_rows){
          $current_delivery_agent_id=$result->row['delivery_agent_id'];
          $result=$this->model_extension_delivery_agent->getDeliveryAgent($current_delivery_agent_id);
          $data['current_delivery_agent']=$result['name'];
          $data['current_delivery_agent_id']=$result['delivery_agent_id'];
        }
      ]]></add>
    </operation>
  </file>
  <file name="admin/view/template/sale/order_info.tpl">
    <operation>
      <search position="before" index="2"><![CDATA[
        </table>
      ]]></search>
      <add><![CDATA[
      <?php if (!empty ($lat_long)): ?>
        <tr>
          <td style="width: 1%">
            <button data-toggle="tooltip" title="" class="btn btn-info btn-xs" data-original-title="Location"><i class="fa fa-map fa-fw"></i></button>
          </td>
          <td><a target="_blank" href="https://www.google.com/maps/search/?api=1&query=<?=$lat_long?>">View Location</add></td>
        </tr>
      <?php endif; ?>
      ]]></add>
    </operation>
    <operation>
      <search position="before" index="2"><![CDATA[
        </tbody>
      ]]></search>
      <add><![CDATA[
        <tr>
          <td rowspan="2"><?php echo $text_delivery_agent; ?>
          <td colspan="2">
            <select name="order_delivery_agent_id" id="input-delivery_agent" class="form-control">
              <?php
                echo "<option value='0'>Not set</option>";
                foreach ($delivery_agents as $delivery_agent) {
              ?>
                <option value="<?php echo $delivery_agent['delivery_agent_id']; ?>" <?php echo isset($current_delivery_agent_id) && $current_delivery_agent_id== $delivery_agent['delivery_agent_id']?"selected":''; ?>>
                <?php echo $delivery_agent['name']; ?></option>
              <?php } ?>
            </select>
          </td>
        </tr>
        <tr>
          <td colspan="2">
          <button id='reset_delivery_agent_btn' class="btn btn-danger btn-md">Reset Agent</button>&nbsp;
          <button id='set_delivery_agent_btn' class="btn btn-success btn-md">Set Agent</button></td>
        </tr>
      ]]></add>
    </operation>
    <operation>
      <search position="before"><![CDATA[
        $('select[name="order_status_id"]').change(function(){
      ]]></search>
      <add><![CDATA[
        function assignDeliverer(){
          var chosen_delivery_agent_id = $('#input-delivery_agent :selected').val();
          var chosen_delivery_agent_name=$('#input-delivery_agent :selected').text();

          $('#current_delivery_agent').text(chosen_delivery_agent_name);
          $.ajax({
            url: 'index.php?route=extension/delivery_agent/assign&token=<?php echo $token; ?>&order_id=<?php echo $order_id; ?>&delivery_agent_id=' + chosen_delivery_agent_id,
          });
        }

        function resetAgent(){
           $.ajax({
            url: 'index.php?route=extension/delivery_agent/unassign&token=<?php echo $token; ?>&order_id=<?php echo $order_id; ?>'
          });
          $('#input-delivery_agent').val(0);
        }

        $('#set_delivery_agent_btn').click(function(){
          assignDeliverer();
        });

        $('#reset_delivery_agent_btn').click(function(){
          resetAgent();
        });
      ]]></add>
    </operation>
  </file>
</modification>
